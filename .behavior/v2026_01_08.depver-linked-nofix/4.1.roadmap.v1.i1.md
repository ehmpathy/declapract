# roadmap: depver-linked-nofix

## overview

execute the blueprint to make `@declapract{check.minVersion()}` preserve linked dependency versions (`link:.`, `link:../path`) instead of replace them with semver strings.

---

## phase 1: core utility

### 1.1 create `isLinkedDependencyVersion` utility

- [ ] **file**: `src/domain.operations/declaration/readPracticeDeclarations/readPracticeDeclaration/getFileCheckDeclaration/checkExpressions/check.minVersion.ts`
- **action**: add new exported function `isLinkedDependencyVersion`
- **depends on**: none

```ts
export const isLinkedDependencyVersion = (value: unknown): boolean => {
  if (typeof value !== 'string') return false;
  return value.startsWith('link:');
};
```

**acceptance criteria**:
- function exists and is exported
- returns `true` for `link:.`, `link:..`, `link:../path`, `link:/absolute`
- returns `false` for semver strings, `file:` protocol, null, undefined, numbers

**verification**:
```bash
npm run test:types
```

---

### 1.2 create unit tests for `isLinkedDependencyVersion`

- [ ] **file**: `src/domain.operations/declaration/readPracticeDeclarations/readPracticeDeclaration/getFileCheckDeclaration/checkExpressions/check.minVersion.test.ts` (new file)
- **action**: create test file with data-driven test cases
- **depends on**: 1.1

**acceptance criteria**:
- test file exists
- covers all linked version patterns: `link:.`, `link:..`, `link:../adjacent`, `link:/absolute`
- covers non-linked values: semver, ranges, `file:` protocol, empty string, null, undefined, numbers

**verification**:
```bash
npm run test:unit -- check.minVersion.test.ts
```

---

## phase 2: check logic

### 2.1 update `checkDoesFoundValuePassesMinVersionCheck`

- [ ] **file**: `src/domain.operations/declaration/readPracticeDeclarations/readPracticeDeclaration/getFileCheckDeclaration/checkExpressions/check.minVersion.ts`
- **action**: modify function to return `true` early for linked versions
- **depends on**: 1.1

```ts
export const checkDoesFoundValuePassesMinVersionCheck = ({
  foundValue,
  minVersion,
}: {
  foundValue: any;
  minVersion: string;
}): boolean => {
  // linked versions always pass - they use the latest local code by definition
  if (isLinkedDependencyVersion(foundValue)) return true;

  // ... rest of logic unchanged
};
```

**acceptance criteria**:
- linked versions return `true` regardless of minVersion
- semver behavior unchanged

**verification**:
```bash
npm run test:unit -- check.minVersion.test.ts
```

---

### 2.2 add unit tests for linked version check behavior

- [ ] **file**: `src/domain.operations/declaration/readPracticeDeclarations/readPracticeDeclaration/getFileCheckDeclaration/checkExpressions/check.minVersion.test.ts`
- **action**: add test cases for `checkDoesFoundValuePassesMinVersionCheck` with linked versions
- **depends on**: 2.1

**acceptance criteria**:
- `link:.` passes any minVersion check
- `link:../path` passes any minVersion check
- semver still fails when below minVersion
- semver still passes when at or above minVersion

**verification**:
```bash
npm run test:unit -- check.minVersion.test.ts
```

---

### 2.3 add unit tests for `checkContainsJSON` with linked versions

- [ ] **file**: `src/domain.operations/declaration/readPracticeDeclarations/readPracticeDeclaration/getFileCheckDeclaration/checkMethods/composableActions/checkContainsJSON.test.ts`
- **action**: add test cases for linked versions with minVersion checks
- **depends on**: 2.1

**acceptance criteria**:
- `checkContainsJSON` returns no error when found version is `link:.` and declared is `check.minVersion('x.y.z')`
- behavior unchanged for semver versions

**verification**:
```bash
npm run test:unit -- checkContainsJSON.test.ts
```

---

## phase 3: fix logic

### 3.1 update `deepReplaceOrAddCurrentKeyValuesWithDesiredKeyValues`

- [ ] **file**: `src/domain.operations/declaration/readPracticeDeclarations/readPracticeDeclaration/getFileCheckDeclaration/fixMethods/fixContainsJSONByReplacingAndAddingKeyValues.ts`
- **action**: import `isLinkedDependencyVersion` and preserve linked versions in fix logic
- **depends on**: 1.1

```ts
import {
  checkDoesFoundValuePassesMinVersionCheck,
  getMinVersionFromCheckMinVersionExpression,
  isCheckMinVersionExpression,
  isLinkedDependencyVersion,
} from '...check.minVersion';

// inside deepReplaceOrAddCurrentKeyValuesWithDesiredKeyValues:
if (isCheckMinVersionExpression(desiredValue)) {
  // preserve linked versions - they satisfy any minVersion by definition
  if (isLinkedDependencyVersion(currentValue)) return currentValue;

  // ... rest of logic unchanged
}
```

**acceptance criteria**:
- `link:.` preserved when declared minVersion check exists
- `link:../path` preserved when declared minVersion check exists
- semver still replaced when below minVersion
- semver still preserved when at or above minVersion

**verification**:
```bash
npm run test:types
```

---

### 3.2 add unit tests for fix logic with linked versions

- [ ] **file**: `src/domain.operations/declaration/readPracticeDeclarations/readPracticeDeclaration/getFileCheckDeclaration/fixMethods/fixContainsJSONByReplacingAndAddingKeyValues.test.ts`
- **action**: add test cases for linked version preservation
- **depends on**: 3.1

**acceptance criteria**:
- `link:.` NOT replaced with minVersion string
- `link:../adjacent-package` NOT replaced with minVersion string
- semver below minVersion IS replaced with minVersion string

**verification**:
```bash
npm run test:unit -- fixContainsJSONByReplacingAndAddingKeyValues.test.ts
```

---

## phase 4: integration verification

### 4.1 run type check

- [ ] **action**: verify all types compile
- **depends on**: 3.1

**verification**:
```bash
npm run test:types
```

---

### 4.2 run lint check

- [ ] **action**: verify code style
- **depends on**: 3.1

**verification**:
```bash
npm run test:lint
```

---

### 4.3 run all unit tests

- [ ] **action**: verify all unit tests pass
- **depends on**: 1.2, 2.2, 2.3, 3.2

**verification**:
```bash
npm run test:unit
```

---

### 4.4 run all integration tests

- [ ] **action**: verify integration tests pass
- **depends on**: 4.3

**verification**:
```bash
npm run test:integration
```

---

## phase 5: acceptance verification

### 5.1 manual verification

- [ ] **action**: verify end-to-end behavior with real project
- **depends on**: 4.4

**steps**:
1. find or create a project with `link:.` dependency
2. create a practice that declares `minVersion` for that dependency
3. run `declapract plan` and verify no fix is proposed for linked dependency
4. run `declapract apply` and verify `link:.` is preserved unchanged

**acceptance criteria**:
- `link:.` dependency shows minVersion check as satisfied
- `link:.` dependency is NOT replaced by semver string
- non-linked dependencies below minVersion ARE still fixed

---

## summary checklist

| step | description | depends on | verification |
|------|-------------|------------|--------------|
| 1.1 | create `isLinkedDependencyVersion` | - | `test:types` |
| 1.2 | unit tests for utility | 1.1 | `test:unit -- check.minVersion.test.ts` |
| 2.1 | update check logic | 1.1 | `test:unit -- check.minVersion.test.ts` |
| 2.2 | unit tests for check behavior | 2.1 | `test:unit -- check.minVersion.test.ts` |
| 2.3 | unit tests for checkContainsJSON | 2.1 | `test:unit -- checkContainsJSON.test.ts` |
| 3.1 | update fix logic | 1.1 | `test:types` |
| 3.2 | unit tests for fix behavior | 3.1 | `test:unit -- fixContainsJSONByReplacingAndAddingKeyValues.test.ts` |
| 4.1 | type check | 3.1 | `test:types` |
| 4.2 | lint check | 3.1 | `test:lint` |
| 4.3 | all unit tests | 1.2, 2.2, 2.3, 3.2 | `test:unit` |
| 4.4 | integration tests | 4.3 | `test:integration` |
| 5.1 | manual verification | 4.4 | manual |

---

## dependency graph

```
1.1 ─────┬──────► 1.2
         │
         ├──────► 2.1 ──────► 2.2
         │         │
         │         └──────► 2.3
         │
         └──────► 3.1 ──────► 3.2
                   │
                   ├──────► 4.1
                   │
                   └──────► 4.2

1.2, 2.2, 2.3, 3.2 ──────► 4.3 ──────► 4.4 ──────► 5.1
```
